<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد مدیریت هزینه</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker/dist/css/persian-datepicker.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-date/dist/persian-date.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-datepicker/dist/js/persian-datepicker.min.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Tahoma', sans-serif;
        }
        .dashboard-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .btn-custom {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            transition: 0.3s;
        }
        .btn-custom:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
<div class="dashboard-container">
    <h2>داشبورد مدیریت مالی</h2>
    <p>به پنل مدیریت مالی خود خوش آمدید!</p>

    <!-- دکمه افزودن هزینه جدید -->
    <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#expenseModal">+ افزودن هزینه جدید</button>

    <!-- دکمه افزودن دسته‌بندی هزینه -->
    <button class="btn btn-dark mt-3" data-bs-toggle="modal" data-bs-target="#categoryModal">+ افزودن دسته‌بندی هزینه</button>

    <!-- دکمه افزودن درآمد جدید -->
    <button class="btn btn-success mt-3" data-bs-toggle="modal" data-bs-target="#incomeModal">+ افزودن درآمد جدید</button>

    <!-- دکمه افزودن دسته‌بندی درآمد -->
    <button class="btn btn-info mt-3" data-bs-toggle="modal" data-bs-target="#incomeCategoryModal">+ افزودن دسته‌بندی درآمد</button>

    <!-- دکمه گزارش‌ها -->
    <a href="/report" class="btn btn-warning mt-3">مشاهده گزارش‌ها</a>
</div>

    <!-- Modal -->
    <div class="modal fade" id="expenseModal" tabindex="-1" aria-labelledby="expenseModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="expenseModalLabel">افزودن هزینه جدید</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="expenseForm">
                        <div class="mb-3">
                            <label for="amount" class="form-label">مبلغ</label>
                            <input type="number" class="form-control" id="amount" name="amount" required>
                        </div>
                        <div class="mb-3">
                            <label for="category" class="form-label">دسته‌بندی</label>
                                <select class="form-control" id="category" name="category">
                                    {% for category in categories %}
                                        <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>

                        </div>
                        <div class="mb-3">
                            <label for="date" class="form-label">تاریخ</label>
                            <input type="text" class="form-control" id="date" name="date">
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">توضیحات</label>
                            <textarea class="form-control" id="description" name="description"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">ثبت هزینه</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


<!-- Modal برای افزودن دسته‌بندی جدید -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalLabel">افزودن دسته‌بندی جدید</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">نام دسته‌بندی</label>
                        <input type="text" class="form-control" id="categoryName" name="categoryName" required>
                    </div>
                    <button type="submit" class="btn btn-primary">ثبت دسته‌بندی</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- فرم افزودن دسته‌بندی درآمد -->
<div class="modal fade" id="incomeCategoryModal" tabindex="-1" aria-labelledby="incomeCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="incomeCategoryModalLabel">افزودن دسته‌بندی درآمد جدید</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="incomeCategoryForm">
                    <div class="mb-3">
                        <label for="incomeCategoryName" class="form-label">نام دسته‌بندی</label>
                        <input type="text" class="form-control" id="incomeCategoryName" name="incomeCategoryName" required>
                    </div>
                    <button type="submit" class="btn btn-primary">ثبت دسته‌بندی</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- فرم افزودن درآمد -->
<div class="modal fade" id="incomeModal" tabindex="-1" aria-labelledby="incomeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="incomeModalLabel">افزودن درآمد جدید</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="incomeForm">
                    <div class="mb-3">
                        <label for="incomeAmount" class="form-label">مبلغ</label>
                        <input type="number" class="form-control" id="incomeAmount" name="incomeAmount" required>
                    </div>
                    <div class="mb-3">
                        <label for="incomeCategory" class="form-label">دسته‌بندی</label>
                        <select class="form-control" id="incomeCategory" name="incomeCategory">
                            {% for category in income_categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="incomeDescription" class="form-label">توضیحات</label>
                        <textarea class="form-control" id="incomeDescription" name="incomeDescription"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">ثبت درآمد</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // افزودن دسته‌بندی درآمد
    $("#incomeCategoryForm").submit(function(event) {
        event.preventDefault();
        let incomeCategoryName = $("#incomeCategoryName").val().trim();
        if (incomeCategoryName === "") {
            alert("نام دسته‌بندی نمی‌تواند خالی باشد.");
            return;
        }
        $.ajax({
            url: "/add_income_category",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ incomeCategoryName: incomeCategoryName }),
            success: function(response) {
                alert(response.message);
                $("#incomeCategoryModal").modal("hide");
                $("#incomeCategoryName").val("");
                $("#incomeCategory").append(`<option value="${response.category_id}">${response.category_name}</option>`);
            },
            error: function(xhr, status, error) {
                alert("مشکلی در ثبت دسته‌بندی درآمد پیش آمده: " + xhr.responseText);
            }
        });
    });

    // ثبت درآمد
    $("#incomeForm").submit(function(event) {
        event.preventDefault();
        let incomeAmount = $("#incomeAmount").val().trim();
        let incomeCategory = $("#incomeCategory").val();
        let incomeDescription = $("#incomeDescription").val().trim();
        if (incomeAmount === "" || incomeCategory === "") {
            alert("تمامی فیلدها باید پر شوند!");
            return;
        }
        $.ajax({
            url: "/add_income",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                incomeAmount: incomeAmount,
                incomeCategory: incomeCategory,
                incomeDescription: incomeDescription
            }),
            success: function(response) {
                alert(response.message);
                $("#incomeAmount").val("");
                $("#incomeCategory").val("");
                $("#incomeDescription").val("");
                let newIncome = response.income;
                let incomeRow = `<tr>
                    <td>${newIncome.id}</td>
                    <td>${newIncome.amount}</td>
                    <td>${newIncome.category}</td>
                    <td>${newIncome.description}</td>
                    <td>${newIncome.date}</td>
                </tr>`;
                $("#incomeTable tbody").append(incomeRow);
            },
            error: function(xhr, status, error) {
                alert("مشکلی در ثبت درآمد پیش آمده است. لطفاً دوباره تلاش کنید.");
            }
        });
    });
});

</script>

<script>
    $(document).ready(function() {
    $("#categoryForm").submit(function(event) {
        event.preventDefault();

        let categoryName = $("#categoryName").val().trim();

        if (categoryName === "") {
            alert("نام دسته‌بندی نمی‌تواند خالی باشد.");
            return;
        }

        $.ajax({
            url: "/add_category",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ categoryName: categoryName }),
            success: function(response) {
                alert(response.message);
                $("#categoryModal").modal("hide");
                $("#categoryName").val("");
                $("#category").append(`<option value="${response.category_id}">${response.category_name}</option>`);
            },
            error: function(xhr, status, error) {
                console.log("Error:", xhr.responseText);
                alert("مشکلی در ثبت دسته‌بندی پیش آمده: " + xhr.responseText);
            }
        });
    });
});
    </script>

    <script>
    $(document).ready(function() {
    $("#expenseForm").submit(function(event) {
        event.preventDefault();

        // دریافت داده‌ها از فرم
        let amount = $("#amount").val().trim();
        let category = $("#category").val();
        let description = $("#description").val().trim();

        // بررسی صحت داده‌ها
        if (amount === "" || category === "") {
            alert("تمامی فیلدها باید پر شوند!");
            return;
        }

        // ارسال درخواست AJAX
        $.ajax({
            url: "/add_expense",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                amount: amount,
                category: category,
                description: description
            }),
            success: function(response) {
                alert(response.message);
                // پاک کردن مقادیر فرم بعد از ارسال موفق
                $("#amount").val("");
                $("#category").val("");
                $("#description").val("");

                // نمایش هزینه جدید در جایی که نمایش می‌دهید
                let newExpense = response.expense;
                let expenseRow = <tr>
                    <td>${newExpense.id}</td>
                    <td>${newExpense.amount}</td>
                    <td>${newExpense.category}</td>
                    <td>${newExpense.description}</td>
                    <td>${newExpense.date}</td>
                </tr>;

                // اضافه کردن هزینه به جدول یا لیست
                $("#expensesTable tbody").append(expenseRow);
            },
            error: function(xhr, status, error) {
                console.log("Error:", error);
                alert("مشکلی در ثبت هزینه پیش آمده است. لطفاً دوباره تلاش کنید.");
            }
        });
    });
});

    </script>

    <script>
        $(document).ready(function() {
            $("#date").persianDatepicker({
                format: 'YYYY-MM-DD'
            });
        });
    </script>
</body>
</html>